# -----------------------------------------------------
# DEV ENV
# -----------------------------------------------------

# Local user bin
export PATH="$HOME/.local/bin:$PATH"

# -----------------------------------------------------
# Python
# -----------------------------------------------------

# ---- pyenv (lazy) ----
export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"

typeset -g __pyenv_lazy_loaded=0

_load_pyenv_lazy() {
  (( __pyenv_lazy_loaded )) && return
  __pyenv_lazy_loaded=1

  if command -v pyenv >/dev/null 2>&1; then
    eval "$(pyenv init -)"
  fi

  unfunction python python3 pip pip3 pyenv ipython pydoc pytest 2>/dev/null || true
}

python() {
  _load_pyenv_lazy
  command python "$@"
}

python3() {
  _load_pyenv_lazy
  command python3 "$@"
}

pip() {
  _load_pyenv_lazy
  command pip "$@"
}

pip3() {
  _load_pyenv_lazy
  command pip3 "$@"
}

pyenv() {
  _load_pyenv_lazy
  command pyenv "$@"
}

ipython() {
  _load_pyenv_lazy
  command ipython "$@"
}

pydoc() {
  _load_pyenv_lazy
  command pydoc "$@"
}

pytest() {
  _load_pyenv_lazy
  command pytest "$@"
}

# ---- conda ----
if [ -f /opt/miniconda3/etc/profile.d/conda.sh ]; then
  . /opt/miniconda3/etc/profile.d/conda.sh
  if [ -n "$CONDA_PREFIX" ]; then
    # Ensure conda bin comes before pyenv shims when active
    export PATH="$CONDA_PREFIX/bin:$PATH"
  fi
fi

# -----------------------------------------------------
# Language runtimes
# -----------------------------------------------------
export JAVA_HOME="/usr/lib/jvm/java-21-openjdk"
export PATH="$JAVA_HOME/bin:$PATH"

# -----------------------------------------------------
# Apache Arrow
# -----------------------------------------------------
if [ -n "$CONDA_PREFIX" ]; then
  export ARROW_HOME="$CONDA_PREFIX"
fi

export ARROW_PROJECT="$HOME/PycharmProjects/arrow"
export PARQUET_TEST_DATA="$ARROW_PROJECT/cpp/submodules/parquet-testing/data"
export ARROW_TEST_DATA="$ARROW_PROJECT/testing/data"

# -----------------------------------------------------
# Homebrew
# -----------------------------------------------------
if [ -x /home/linuxbrew/.linuxbrew/bin/brew ]; then
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

# -----------------------------------------------------
# Node
# -----------------------------------------------------

# Bun
[ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"

# PATH exports (additive)
export PNPM_HOME="$HOME/.local/share/pnpm"
export PATH="$PNPM_HOME:$PATH"

typeset -g __node_lazy_loaded=0

_load_node_lazy() {
  local requested_cmd="${1:-}"
  (( __node_lazy_loaded )) && return
  __node_lazy_loaded=1

  if [ -f /usr/share/nvm/init-nvm.sh ]; then
    source /usr/share/nvm/init-nvm.sh
    nvm use default >/dev/null 2>&1 || true
  fi

  if [ "$requested_cmd" = "corepack" ] || [ "$requested_cmd" = "pnpm" ] || [ "$requested_cmd" = "yarn" ]; then
    if command -v corepack >/dev/null 2>&1; then
      corepack enable >/dev/null 2>&1 || true
      corepack prepare pnpm@latest --activate >/dev/null 2>&1 || true
    fi
  fi

  unfunction node npm npx nvm corepack pnpm yarn 2>/dev/null || true
}

node() {
  _load_node_lazy node
  command node "$@"
}

npm() {
  _load_node_lazy npm
  command npm "$@"
}

npx() {
  _load_node_lazy npx
  command npx "$@"
}

nvm() {
  _load_node_lazy nvm
  command nvm "$@"
}

corepack() {
  _load_node_lazy corepack
  command corepack "$@"
}

pnpm() {
  _load_node_lazy pnpm
  command pnpm "$@"
}

yarn() {
  _load_node_lazy yarn
  command yarn "$@"
}



# VSCODE
[[ "$TERM_PROGRAM" == "vscode" ]] && . "$(code --locate-shell-integration-path zsh)"
